@page
@model RazorIdentity.Pages.ProtegidoModel
@{
    ViewData["Title"] = "Administración (Super Admin)";
    var t = Model.Tab ?? "usuarios";
    var userEmail = Model.CurrentUserEmail ?? "Admin";
    var userInitials = Model.CurrentUserInitials ?? "SA";
    string NavLink(string tab, string icon, string label)
    {
        var active = t == tab;
        return active
            ? "flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-md bg-ritweb-teal text-white transition-all relative"
            : "flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-200 hover:text-slate-900 transition-all";
    }
    string NavLinkBar(string tab) => t == tab ? "absolute right-0 top-0 bottom-0 w-1 bg-codelco-orange rounded-l-full" : "";
}
<div class="flex min-h-screen bg-slate-50">
    <aside id="sidebar" class="fixed left-0 top-0 z-20 h-screen w-72 bg-slate-100 border-r border-slate-200 flex flex-col transition-all duration-300 ease-in-out" aria-label="Menú de administración">
        <div class="p-4 flex items-center justify-between gap-2 border-b border-slate-200">
            <a asp-page="/Protegido" asp-route-tab="usuarios" class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 bg-ritweb-teal rounded-lg flex items-center justify-center text-white font-bold text-xl flex-shrink-0">R</div>
                <div class="min-w-0 sidebar-logo-text">
                    <h1 class="font-bold text-lg leading-tight tracking-tight text-slate-800 truncate">RitWeb</h1>
                    <p class="text-[10px] uppercase tracking-widest text-slate-500 font-semibold">Codelco Admin</p>
                </div>
            </a>
            <button type="button" id="sidebar-toggle" class="p-2 rounded-md text-slate-500 hover:bg-slate-200 hover:text-slate-700 transition-colors flex-shrink-0" aria-label="Minimizar o expandir menú">
                <span class="material-icons sidebar-icon-expand">chevron_left</span>
                <span class="material-icons sidebar-icon-collapse hidden">chevron_right</span>
            </button>
        </div>
        <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
            <p class="px-3 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider sidebar-label">Administración</p>
            <a asp-page="/Protegido" asp-route-tab="usuarios" class="@NavLink("usuarios", "group", "Sostenedor de usuarios")">
                <span class="material-icons text-[20px] flex-shrink-0">group</span>
                <span class="sidebar-text truncate">Sostenedor de usuarios</span>
                <div class="@NavLinkBar("usuarios")"></div>
            </a>
            <a asp-page="/Protegido" asp-route-tab="paises" class="@NavLink("paises", "public", "Países")">
                <span class="material-icons text-[20px] flex-shrink-0">public</span>
                <span class="sidebar-text truncate">Países</span>
                <div class="@NavLinkBar("paises")"></div>
            </a>
            <a asp-page="/Protegido" asp-route-tab="regiones" class="@NavLink("regiones", "map", "Regiones")">
                <span class="material-icons text-[20px] flex-shrink-0">map</span>
                <span class="sidebar-text truncate">Regiones</span>
                <div class="@NavLinkBar("regiones")"></div>
            </a>
            <a asp-page="/Protegido" asp-route-tab="proyectos" class="@NavLink("proyectos", "assignment", "Proyectos")">
                <span class="material-icons text-[20px] flex-shrink-0">assignment</span>
                <span class="sidebar-text truncate">Proyectos</span>
                <div class="@NavLinkBar("proyectos")"></div>
            </a>
            <a asp-page="/Protegido" asp-route-tab="centros" class="@NavLink("centros", "payments", "Centros de costo")">
                <span class="material-icons text-[20px] flex-shrink-0">payments</span>
                <span class="sidebar-text truncate">Centros de costo</span>
                <div class="@NavLinkBar("centros")"></div>
            </a>
            <a asp-page="/Protegido" asp-route-tab="disciplinas" class="@NavLink("disciplinas", "engineering", "Disciplinas")">
                <span class="material-icons text-[20px] flex-shrink-0">engineering</span>
                <span class="sidebar-text truncate">Disciplinas</span>
                <div class="@NavLinkBar("disciplinas")"></div>
            </a>
            <div class="pt-4 mt-4 border-t border-slate-200">
                <p class="px-3 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider sidebar-label">Asignaciones</p>
                <a asp-page="/Protegido" asp-route-tab="usuarioscentro" class="@NavLink("usuarioscentro", "apartment", "Usuarios por centro")">
                    <span class="material-icons text-[20px] flex-shrink-0">apartment</span>
                    <span class="sidebar-text truncate">Usuarios por centro</span>
                    <div class="@NavLinkBar("usuarioscentro")"></div>
                </a>
                <a asp-page="/Protegido" asp-route-tab="usuariosdisciplina" class="@NavLink("usuariosdisciplina", "shield", "Usuarios por disciplina")">
                    <span class="material-icons text-[20px] flex-shrink-0">shield</span>
                    <span class="sidebar-text truncate">Usuarios por disciplina</span>
                    <div class="@NavLinkBar("usuariosdisciplina")"></div>
                </a>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-200">
            <div class="flex items-center gap-3 p-2 rounded-lg">
                <div class="w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center text-xs font-bold text-slate-700 flex-shrink-0">@userInitials</div>
                <div class="min-w-0 flex-1 sidebar-label">
                    <p class="text-sm font-semibold text-slate-800 truncate">Super Admin</p>
                    <p class="text-[10px] text-slate-500 truncate">@userEmail</p>
                </div>
                <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })" method="post" class="flex-shrink-0">
                    <button type="submit" class="p-1.5 rounded text-slate-400 hover:bg-slate-200 hover:text-slate-700 transition-colors" title="Cerrar sesión">
                        <span class="material-icons text-xl">logout</span>
                    </button>
                </form>
            </div>
        </div>
    </aside>
    <main id="main-content" class="flex-1 ml-72 p-8 lg:p-12 transition-all duration-300 ease-in-out min-h-screen">
        @if (Model.ErrorApi != null)
        {
            <div class="mb-6 rounded-xl bg-amber-50 border border-amber-200/80 p-4 text-amber-800 text-sm shadow-sm flex items-start gap-3">
                <span class="material-icons text-amber-600 text-xl flex-shrink-0">warning</span>
                <span>@Model.ErrorApi</span>
            </div>
        }
        <header class="mb-10">
            <div class="flex justify-between items-start mb-2">
                <h2 class="text-3xl font-bold tracking-tight text-slate-900">Contenido Protegido</h2>
                <div class="flex gap-2">
                    <button type="button" class="p-2 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors" aria-label="Notificaciones">
                        <span class="material-icons text-slate-600">notifications</span>
                    </button>
                    <button type="button" class="p-2 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors" onclick="document.documentElement.classList.toggle('dark')" aria-label="Modo oscuro">
                        <span class="material-icons text-slate-600">dark_mode</span>
                    </button>
                </div>
            </div>
            <p class="text-slate-500 max-w-2xl">
                Solo usuarios con rol Super_Admin. CRUD de Países, Regiones, Proyectos, Centros de costo, Disciplinas y asignación de usuarios (centro y disciplina).
            </p>
        </header>
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-6 sm:p-8">

        @* Sostenedor de usuarios: rol, disciplina, centro, proyecto *@
        @if (t == "usuarios")
        {
            <h2 class="text-xl font-semibold text-slate-800 mb-1">Sostenedor de usuarios</h2>
            <p class="text-sm text-slate-600 mb-6">
                Aquí puede <strong>editar el rol</strong> de cada usuario y registrar nuevos. Para asignar <strong>centro de costo</strong> use la pestaña <a asp-page="/Protegido" asp-route-tab="usuarioscentro" class="text-ritweb-teal hover:text-teal-700 font-medium transition-colors">Usuarios por centro</a>. Para asignar <strong>disciplina</strong> use la pestaña <a asp-page="/Protegido" asp-route-tab="usuariosdisciplina" class="text-ritweb-teal hover:text-teal-700 font-medium transition-colors">Usuarios por disciplina</a>. Para gestionar <strong>proyectos</strong> (CRUD) use la pestaña <a asp-page="/Protegido" asp-route-tab="proyectos" class="text-ritweb-teal hover:text-teal-700 font-medium transition-colors">Proyectos</a>.
            </p>
            @if (!string.IsNullOrEmpty(Model.MensajeUsuarios))
            {
                <div class="mb-6 rounded-xl p-4 text-sm flex items-start gap-3 @(Model.MensajeUsuariosEsError ? "bg-red-50 border border-red-200/80 text-red-800 shadow-sm" : "bg-emerald-50 border border-emerald-200/80 text-emerald-800 shadow-sm")">
                    <span class="material-icons flex-shrink-0 @(Model.MensajeUsuariosEsError ? "text-red-500" : "text-emerald-600")">@(Model.MensajeUsuariosEsError ? "error" : "check_circle")</span>
                    <span>@(Model.MensajeUsuarios)</span>
                </div>
            }
            <div class="rounded-xl bg-slate-50/80 border border-slate-200/80 p-4 sm:p-5 mb-6">
                <h3 class="text-sm font-semibold text-slate-700 mb-3">Buscar usuario</h3>
                <form method="get" asp-page="/Protegido" class="flex flex-wrap items-end gap-3">
                    <input type="hidden" name="tab" value="usuarios" />
                    <label class="flex flex-col gap-1.5">
                        <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Email o nombre</span>
                        <input type="text" name="usuarioBusqueda" value="@(Model.UsuarioBusqueda)" class="w-64 border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal transition" placeholder="Ej: correo&#64;ejemplo.cl" />
                    </label>
                    <button type="submit" class="inline-flex items-center justify-center px-4 py-2 rounded-md text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 shadow-sm hover:shadow transition-colors">Buscar</button>
                    @if (!string.IsNullOrEmpty(Model.UsuarioBusqueda)) { <a asp-page="/Protegido" asp-route-tab="usuarios" class="inline-flex items-center justify-center px-4 py-2 rounded-md text-sm font-medium text-slate-700 bg-white border border-slate-300 hover:bg-slate-50 transition-colors">Ver todos</a> }
                </form>
            </div>
            <div class="rounded-xl bg-slate-50/80 border border-slate-200/80 p-4 sm:p-5 mb-6">
                <h3 class="text-sm font-semibold text-slate-700 mb-3">Registrar nuevo usuario</h3>
                <form method="post" asp-page-handler="CreateUsuario" class="flex flex-wrap items-end gap-4">
                    <input type="hidden" name="tab" value="usuarios" />
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Email</span><input type="email" name="email" class="w-56 border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal transition" placeholder="usuario&#64;ejemplo.cl" required /></label>
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Contraseña</span><input type="password" name="password" class="w-40 border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal transition" minlength="6" required /></label>
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Confirmar</span><input type="password" name="confirmPassword" class="w-40 border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal transition" minlength="6" required /></label>
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Rol inicial</span><select name="rolInicial" class="w-40 border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal transition" required>@foreach (var r in Model.Roles) { <option value="@r">@r</option> }</select></label>
                    <button type="submit" class="inline-flex items-center justify-center px-4 py-2 rounded-md text-sm font-medium text-white bg-ritweb-teal hover:bg-teal-700 shadow-sm hover:shadow transition-colors">Crear usuario</button>
                </form>
            </div>
            <h3 class="text-sm font-semibold text-slate-700 mb-3">Usuarios (editar rol, asignar centro y disciplina)</h3>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="min-w-full">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Rol actual</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Cambiar rol</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Asignar</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                        @foreach (var item in Model.UsuariosConRoles)
                        {
                            var rolesTexto = item.Roles.Count > 0 ? string.Join(", ", item.Roles) : "—";
                            <tr class="hover:bg-slate-50/80 transition-colors">
                                <td class="px-4 py-3 text-sm text-slate-800 font-medium">@(item.User.Email ?? item.User.UserName ?? item.User.Id)</td>
                                <td class="px-4 py-3 text-sm text-slate-600">@rolesTexto</td>
                                <td class="px-4 py-3">
                                    <form method="post" asp-page-handler="ChangeRol" class="inline flex items-center gap-2">
                                        <input type="hidden" name="userId" value="@item.User.Id" />
                                        <input type="hidden" name="usuarioBusqueda" value="@(Model.UsuarioBusqueda)" />
                                        <select name="nuevoRol" class="w-36 py-1.5 text-sm border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal transition">
                                            @foreach (var r in Model.Roles)
                                            {
                                                if (item.Roles.FirstOrDefault() == r)
                                                { <option value="@r" selected>@r</option> }
                                                else
                                                { <option value="@r">@r</option> }
                                            }
                                        </select>
                                        <button type="submit" class="text-ritweb-teal hover:text-teal-700 text-sm font-medium transition-colors">Aplicar</button>
                                    </form>
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <a asp-page="/Protegido" asp-route-tab="usuarioscentro" class="inline-flex items-center px-2.5 py-1 rounded-md bg-slate-100 text-slate-700 hover:bg-ritweb-teal hover:text-white text-xs font-medium transition-colors mr-1">Centro</a>
                                    <a asp-page="/Protegido" asp-route-tab="usuariosdisciplina" class="inline-flex items-center px-2.5 py-1 rounded-md bg-slate-100 text-slate-700 hover:bg-ritweb-teal hover:text-white text-xs font-medium transition-colors">Disciplina</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @* Países *@
        @if (t == "paises")
        {
            <h2 class="text-xl font-semibold text-slate-800 mb-6">Países</h2>
            @if (Model.EditPaisId.HasValue)
            {
                var edit = Model.Paises.FirstOrDefault(x => x.Id == Model.EditPaisId.Value);
                if (edit != null)
                {
                    <div class="mb-6 rounded-xl bg-amber-50/80 border border-amber-200/80 p-4">
                        <form method="post" asp-page-handler="UpdatePais" class="flex flex-wrap items-end gap-3">
                            <input type="hidden" name="id" value="@edit.Id" />
                            <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Nombre</span><input type="text" name="nombre" value="@edit.Nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-64" required /></label>
                            <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 shadow-sm transition-colors">Guardar</button>
                            <a asp-page="/Protegido" asp-route-tab="paises" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-slate-700 border border-slate-300 hover:bg-slate-50 transition-colors">Cancelar</a>
                        </form>
                    </div>
                }
            }
            <div class="rounded-xl bg-slate-50/80 border border-slate-200/80 p-4 sm:p-5 mb-6">
                <form method="post" asp-page-handler="CreatePais" class="flex flex-wrap items-end gap-4">
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Nombre</span><input type="text" name="nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-64" placeholder="Nuevo país" required /></label>
                    <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-ritweb-teal hover:bg-teal-700 shadow-sm transition-colors">Agregar</button>
                </form>
            </div>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="min-w-full">
                    <thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Id</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nombre</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th></tr></thead>
                    <tbody class="divide-y divide-slate-200">
                        @foreach (var p in Model.Paises)
                        {
                            <tr class="hover:bg-slate-50/80 transition-colors"><td class="px-4 py-3 text-sm text-slate-800">@p.Id</td><td class="px-4 py-3 text-sm font-medium text-slate-800">@p.Nombre</td>
                                <td class="px-4 py-3">
                                    <a asp-page="/Protegido" asp-route-tab="paises" asp-route-editPaisId="@p.Id" class="text-ritweb-teal hover:text-teal-700 text-sm font-medium mr-3">Editar</a>
                                    <form method="post" asp-page-handler="DeletePais" class="inline"><input type="hidden" name="id" value="@p.Id" /><button type="submit" class="text-red-600 hover:text-red-700 text-sm font-medium" onclick="return confirm('¿Eliminar este país?');">Eliminar</button></form>
                                </td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @* Regiones *@
        @if (t == "regiones")
        {
            <h2 class="text-xl font-semibold text-slate-800 mb-6">Regiones</h2>
            @if (Model.EditRegionId.HasValue)
            {
                var edit = Model.Regiones.FirstOrDefault(x => x.Id == Model.EditRegionId.Value);
                if (edit != null)
                {
                    <div class="mb-6 rounded-xl bg-amber-50/80 border border-amber-200/80 p-4">
                        <form method="post" asp-page-handler="UpdateRegion" class="flex flex-wrap items-end gap-3">
                            <input type="hidden" name="id" value="@edit.Id" />
                            <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Nombre</span><input type="text" name="nombre" value="@edit.Nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-64" required /></label>
                            <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">País</span><select name="paisId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-48" required>@foreach (var pa in Model.Paises) { @if (pa.Id == edit.PaisId) { <option value="@pa.Id" selected>@pa.Nombre</option> } else { <option value="@pa.Id">@pa.Nombre</option> } }</select></label>
                            <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 shadow-sm transition-colors">Guardar</button>
                            <a asp-page="/Protegido" asp-route-tab="regiones" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-slate-700 border border-slate-300 hover:bg-slate-50 transition-colors">Cancelar</a>
                        </form>
                    </div>
                }
            }
            <div class="rounded-xl bg-slate-50/80 border border-slate-200/80 p-4 sm:p-5 mb-6">
                <form method="post" asp-page-handler="CreateRegion" class="flex flex-wrap items-end gap-4">
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Nombre</span><input type="text" name="nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-64" placeholder="Nueva región" required /></label>
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">País</span><select name="paisId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-48" required>@foreach (var pa in Model.Paises) { <option value="@pa.Id">@pa.Nombre</option> }</select></label>
                    <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-ritweb-teal hover:bg-teal-700 shadow-sm transition-colors">Agregar</button>
                </form>
            </div>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="min-w-full">
                    <thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Id</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nombre</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">País</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th></tr></thead>
                    <tbody class="divide-y divide-slate-200">
                        @foreach (var r in Model.Regiones)
                        {
                            var paisNombre = Model.Paises.FirstOrDefault(pa => pa.Id == r.PaisId)?.Nombre ?? "-";
                            <tr class="hover:bg-slate-50/80 transition-colors"><td class="px-4 py-3 text-sm">@r.Id</td><td class="px-4 py-3 text-sm font-medium text-slate-800">@r.Nombre</td><td class="px-4 py-3 text-sm text-slate-600">@paisNombre</td>
                                <td class="px-4 py-3">
                                    <a asp-page="/Protegido" asp-route-tab="regiones" asp-route-editRegionId="@r.Id" class="text-ritweb-teal hover:text-teal-700 text-sm font-medium mr-3">Editar</a>
                                    <form method="post" asp-page-handler="DeleteRegion" class="inline"><input type="hidden" name="id" value="@r.Id" /><button type="submit" class="text-red-600 hover:text-red-700 text-sm font-medium" onclick="return confirm('¿Eliminar esta región?');">Eliminar</button></form>
                                </td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @* Proyectos *@
        @if (t == "proyectos")
        {
            <h2 class="text-xl font-semibold text-slate-800 mb-6">Proyectos</h2>
            @if (Model.EditProyectoId.HasValue)
            {
                var edit = Model.Proyectos.FirstOrDefault(x => x.Id == Model.EditProyectoId.Value);
                if (edit != null)
                {
                    <form method="post" asp-page-handler="UpdateProyecto" class="mb-4 p-4 bg-slate-50 rounded-lg flex flex-wrap items-end gap-3">
                        <input type="hidden" name="id" value="@edit.Id" />
                        <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Nombre</span><input type="text" name="nombre" value="@edit.Nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-64 transition" required /></label>
                        <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Región</span><select name="regionId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-48 transition" required>@foreach (var re in Model.Regiones) { @if (re.Id == edit.RegionId) { <option value="@re.Id" selected>@re.Nombre</option> } else { <option value="@re.Id">@re.Nombre</option> } }</select></label>
                        <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 shadow-sm transition-colors">Guardar</button>
                        <a asp-page="/Protegido" asp-route-tab="proyectos" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-slate-700 border border-slate-300 hover:bg-slate-50 transition-colors">Cancelar</a>
                    </form>
                }
            }
            <form method="post" asp-page-handler="CreateProyecto" class="mb-4 p-4 bg-slate-50 rounded-lg flex flex-wrap items-end gap-3">
                <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Nombre</span><input type="text" name="nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-64 transition" placeholder="Nuevo proyecto" required /></label>
                <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Región</span><select name="regionId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-48 transition" required>@foreach (var re in Model.Regiones) { <option value="@re.Id">@re.Nombre</option> }</select></label>
                <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-ritweb-teal hover:bg-teal-700 shadow-sm transition-colors">Agregar</button>
            </form>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="min-w-full">
                    <thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Id</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nombre</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Región</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th></tr></thead>
                    <tbody class="divide-y divide-slate-200">
                        @foreach (var pr in Model.Proyectos)
                        {
                            var regionNombre = Model.Regiones.FirstOrDefault(re => re.Id == pr.RegionId)?.Nombre ?? "-";
                            <tr class="hover:bg-slate-50/80 transition-colors"><td class="px-4 py-3 text-sm">@pr.Id</td><td class="px-4 py-3 text-sm font-medium text-slate-800">@pr.Nombre</td><td class="px-4 py-3 text-sm text-slate-600">@regionNombre</td>
                                <td class="px-4 py-3">
                                    <a asp-page="/Protegido" asp-route-tab="proyectos" asp-route-editProyectoId="@pr.Id" class="text-ritweb-teal hover:text-teal-700 text-sm font-medium mr-3">Editar</a>
                                    <form method="post" asp-page-handler="DeleteProyecto" class="inline"><input type="hidden" name="id" value="@pr.Id" /><button type="submit" class="text-red-600 hover:text-red-700 text-sm font-medium" onclick="return confirm('¿Eliminar este proyecto?');">Eliminar</button></form>
                                </td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @* Centros de costo *@
        @if (t == "centros")
        {
            <h2 class="text-xl font-semibold text-slate-800 mb-6">Centros de costo</h2>
            @if (Model.EditCentroId.HasValue)
            {
                var edit = Model.CentrosCosto.FirstOrDefault(x => x.Id == Model.EditCentroId.Value);
                if (edit != null)
                {
                    <form method="post" asp-page-handler="UpdateCentro" class="mb-4 p-4 bg-slate-50 rounded-lg flex flex-wrap items-end gap-3">
                        <input type="hidden" name="id" value="@edit.Id" />
                        <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Nombre</span><input type="text" name="nombre" value="@edit.Nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-64 transition" required /></label>
                        <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Proyecto</span><select name="proyectoId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-48 transition" required>@foreach (var pr in Model.Proyectos) { @if (pr.Id == edit.ProyectoId) { <option value="@pr.Id" selected>@pr.Nombre</option> } else { <option value="@pr.Id">@pr.Nombre</option> } }</select></label>
                        <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 shadow-sm transition-colors">Guardar</button>
                        <a asp-page="/Protegido" asp-route-tab="centros" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-slate-700 border border-slate-300 hover:bg-slate-50 transition-colors">Cancelar</a>
                    </form>
                }
            }
            <form method="post" asp-page-handler="CreateCentro" class="mb-4 p-4 bg-slate-50 rounded-lg flex flex-wrap items-end gap-3">
                <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Nombre</span><input type="text" name="nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-64 transition" placeholder="Nuevo centro" required /></label>
                <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Proyecto</span><select name="proyectoId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-48 transition" required>@foreach (var pr in Model.Proyectos) { <option value="@pr.Id">@pr.Nombre</option> }</select></label>
                <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-ritweb-teal hover:bg-teal-700 shadow-sm transition-colors">Agregar</button>
            </form>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="min-w-full">
                    <thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Id</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nombre</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Proyecto</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th></tr></thead>
                    <tbody class="divide-y divide-slate-200">
                        @foreach (var c in Model.CentrosCosto)
                        {
                            var proyNombre = Model.Proyectos.FirstOrDefault(pr => pr.Id == c.ProyectoId)?.Nombre ?? "-";
                            <tr class="hover:bg-slate-50/80 transition-colors"><td class="px-4 py-3 text-sm">@c.Id</td><td class="px-4 py-3 text-sm font-medium text-slate-800">@c.Nombre</td><td class="px-4 py-3 text-sm text-slate-600">@proyNombre</td>
                                <td class="px-4 py-3">
                                    <a asp-page="/Protegido" asp-route-tab="centros" asp-route-editCentroId="@c.Id" class="text-ritweb-teal hover:text-teal-700 text-sm font-medium mr-3">Editar</a>
                                    <form method="post" asp-page-handler="DeleteCentro" class="inline"><input type="hidden" name="id" value="@c.Id" /><button type="submit" class="text-red-600 hover:text-red-700 text-sm font-medium" onclick="return confirm('¿Eliminar este centro?');">Eliminar</button></form>
                                </td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @* Disciplinas *@
        @if (t == "disciplinas")
        {
            <h2 class="text-xl font-semibold text-slate-800 mb-6">Disciplinas</h2>
            <p class="text-sm text-slate-600 mb-4">Aquí puede agregar, editar y eliminar disciplinas. Luego asocie usuarios a cada disciplina en la pestaña <strong>Usuarios por disciplina</strong>.</p>
            @if (Model.EditDisciplinaId.HasValue)
            {
                var edit = Model.Disciplinas.FirstOrDefault(x => x.Id == Model.EditDisciplinaId.Value);
                if (edit != null)
                {
                    <form method="post" asp-page-handler="UpdateDisciplina" class="mb-4 p-4 bg-slate-50 rounded-lg flex flex-wrap items-end gap-3">
                        <input type="hidden" name="id" value="@edit.Id" />
                        <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Nombre</span><input type="text" name="nombre" value="@edit.Nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-64 transition" required /></label>
                        <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 shadow-sm transition-colors">Guardar</button>
                        <a asp-page="/Protegido" asp-route-tab="disciplinas" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-slate-700 border border-slate-300 hover:bg-slate-50 transition-colors">Cancelar</a>
                    </form>
                }
            }
            <form method="post" asp-page-handler="CreateDisciplina" class="mb-4 p-4 bg-slate-50 rounded-lg flex flex-wrap items-end gap-3">
                <label class="flex flex-col gap-1"><span class="text-sm text-slate-600">Nombre</span><input type="text" name="nombre" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 focus:border-ritweb-teal w-64 transition" placeholder="Nueva disciplina" required /></label>
                <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-ritweb-teal hover:bg-teal-700 shadow-sm transition-colors">Agregar</button>
            </form>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="min-w-full">
                    <thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Id</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nombre</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th></tr></thead>
                    <tbody class="divide-y divide-slate-200">
                        @foreach (var d in Model.Disciplinas)
                        {
                            <tr class="hover:bg-slate-50/80 transition-colors"><td class="px-4 py-3 text-sm">@d.Id</td><td class="px-4 py-3 text-sm font-medium text-slate-800">@d.Nombre</td>
                                <td class="px-4 py-3">
                                    <a asp-page="/Protegido" asp-route-tab="disciplinas" asp-route-editDisciplinaId="@d.Id" class="text-ritweb-teal hover:text-teal-700 text-sm font-medium mr-3">Editar</a>
                                    <form method="post" asp-page-handler="DeleteDisciplina" class="inline"><input type="hidden" name="id" value="@d.Id" /><button type="submit" class="text-red-600 hover:text-red-700 text-sm font-medium" onclick="return confirm('¿Eliminar esta disciplina?');">Eliminar</button></form>
                                </td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @* Usuarios por centro *@
        @if (t == "usuarioscentro")
        {
            <h2 class="text-xl font-semibold text-slate-800 mb-6">Usuarios por centro de costo</h2>
            <div class="rounded-xl bg-slate-50/80 border border-slate-200/80 p-4 sm:p-5 mb-6">
                <form method="post" asp-page-handler="CreateUsuarioCentro" class="flex flex-wrap items-end gap-4">
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Usuario</span><select name="userId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-64" required>@foreach (var u in Model.Usuarios) { <option value="@u.Id">@(u.Email ?? u.UserName ?? u.Id)</option> }</select></label>
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Centro de costo</span><select name="centroCostoId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-48" required>@foreach (var c in Model.CentrosCosto) { <option value="@c.Id">@c.Nombre</option> }</select></label>
                    <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-ritweb-teal hover:bg-teal-700 shadow-sm transition-colors">Asignar</button>
                </form>
            </div>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="min-w-full">
                    <thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Id</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">UserId</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Centro</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th></tr></thead>
                    <tbody class="divide-y divide-slate-200">
                        @foreach (var uc in Model.UsuariosCentro)
                        {
                            var centroNombre = Model.CentrosCosto.FirstOrDefault(c => c.Id == uc.CentroCostoId)?.Nombre ?? "-";
                            var emailFila = Model.Usuarios.FirstOrDefault(u => u.Id == uc.UserId)?.Email ?? uc.UserId;
                            <tr class="hover:bg-slate-50/80 transition-colors"><td class="px-4 py-3 text-sm">@uc.Id</td><td class="px-4 py-3 text-sm font-medium text-slate-800">@emailFila</td><td class="px-4 py-3 text-sm text-slate-600">@centroNombre</td>
                                <td class="px-4 py-3">
                                    <form method="post" asp-page-handler="DeleteUsuarioCentro" class="inline"><input type="hidden" name="id" value="@uc.Id" /><button type="submit" class="text-red-600 hover:text-red-700 text-sm font-medium" onclick="return confirm('¿Quitar esta asignación?');">Quitar</button></form>
                                </td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @* Usuarios por disciplina *@
        @if (t == "usuariosdisciplina")
        {
            <h2 class="text-xl font-semibold text-slate-800 mb-6">Usuarios por disciplina</h2>
            @if (!string.IsNullOrEmpty(Model.MensajeDisciplina))
            {
                <div class="mb-6 rounded-xl p-4 text-sm flex items-start gap-3 @(Model.MensajeDisciplinaEsError ? "bg-red-50 border border-red-200/80 text-red-800 shadow-sm" : "bg-emerald-50 border border-emerald-200/80 text-emerald-800 shadow-sm")">
                    <span class="material-icons flex-shrink-0 @(Model.MensajeDisciplinaEsError ? "text-red-500" : "text-emerald-600")">@(Model.MensajeDisciplinaEsError ? "error" : "check_circle")</span>
                    <span>@(Model.MensajeDisciplina)</span>
                </div>
            }
            <p class="text-sm text-slate-600 mb-4">Asigne un usuario a una disciplina. Si no hay disciplinas en el listado, agregue primero en la pestaña <strong>Disciplinas</strong>.</p>
            <div class="rounded-xl bg-slate-50/80 border border-slate-200/80 p-4 sm:p-5 mb-6">
                <form method="post" asp-page-handler="CreateUsuarioDisciplina" class="flex flex-wrap items-end gap-4">
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Usuario</span><select name="userId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-64" required>@foreach (var u in Model.Usuarios) { <option value="@u.Id">@(u.Email ?? u.UserName ?? u.Id)</option> }</select></label>
                    <label class="flex flex-col gap-1.5"><span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Disciplina</span><select name="disciplinaId" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ritweb-teal/50 w-48" required>@foreach (var d in Model.Disciplinas) { <option value="@d.Id">@d.Nombre</option> }</select></label>
                    <button type="submit" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-ritweb-teal hover:bg-teal-700 shadow-sm transition-colors">Asignar</button>
                </form>
            </div>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="min-w-full">
                    <thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Id</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Usuario</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Disciplina</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th></tr></thead>
                    <tbody class="divide-y divide-slate-200">
                        @foreach (var ud in Model.UsuariosDisciplina)
                        {
                            var disciplinaNombre = Model.Disciplinas.FirstOrDefault(d => d.Id == ud.DisciplinaId)?.Nombre ?? "-";
                            var emailFila = Model.Usuarios.FirstOrDefault(u => u.Id == ud.UserId)?.Email ?? ud.UserId;
                            <tr class="hover:bg-slate-50/80 transition-colors"><td class="px-4 py-3 text-sm">@ud.Id</td><td class="px-4 py-3 text-sm font-medium text-slate-800">@emailFila</td><td class="px-4 py-3 text-sm text-slate-600">@disciplinaNombre</td>
                                <td class="px-4 py-3">
                                    <form method="post" asp-page-handler="DeleteUsuarioDisciplina" class="inline"><input type="hidden" name="id" value="@ud.Id" /><button type="submit" class="text-red-600 hover:text-red-700 text-sm font-medium" onclick="return confirm('¿Quitar esta asignación?');">Quitar</button></form>
                                </td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        </div>
        <div class="h-1 bg-codelco-orange/20">
            <div class="h-full bg-codelco-orange w-1/4"></div>
        </div>
        <footer class="mt-12 text-center text-slate-400 text-xs">
            © @DateTime.Now.Year RitWeb Codelco. Todos los derechos reservados.
        </footer>
    </main>
</div>
<style>
    #sidebar.sidebar-collapsed nav a { justify-content: center; padding-left: 0; padding-right: 0; }
    #sidebar.sidebar-collapsed .px-4 { padding-left: 0.5rem; padding-right: 0.5rem; }
</style>
<script>
(function () {
    var STORAGE_KEY = 'protegido-sidebar-collapsed';
    var sidebar = document.getElementById('sidebar');
    var main = document.getElementById('main-content');
    var toggle = document.getElementById('sidebar-toggle');
    var iconExpand = document.querySelector('.sidebar-icon-expand');
    var iconCollapse = document.querySelector('.sidebar-icon-collapse');
    var labels = document.querySelectorAll('.sidebar-label');
    var texts = document.querySelectorAll('.sidebar-text');
    var logoTexts = document.querySelectorAll('.sidebar-logo-text');

    function isCollapsed() { return localStorage.getItem(STORAGE_KEY) === '1'; }

    function applyState(collapsed) {
        if (collapsed) {
            sidebar.classList.add('sidebar-collapsed', 'w-20');
            sidebar.classList.remove('w-72');
            main.classList.remove('ml-72');
            main.classList.add('ml-20');
            if (iconExpand) iconExpand.classList.add('hidden');
            if (iconCollapse) iconCollapse.classList.remove('hidden');
            labels.forEach(function (el) { el.classList.add('hidden'); });
            texts.forEach(function (el) { el.classList.add('hidden'); });
            logoTexts.forEach(function (el) { el.classList.add('hidden'); });
        } else {
            sidebar.classList.remove('sidebar-collapsed', 'w-20');
            sidebar.classList.add('w-72');
            main.classList.remove('ml-20');
            main.classList.add('ml-72');
            if (iconExpand) iconExpand.classList.remove('hidden');
            if (iconCollapse) iconCollapse.classList.add('hidden');
            labels.forEach(function (el) { el.classList.remove('hidden'); });
            texts.forEach(function (el) { el.classList.remove('hidden'); });
            logoTexts.forEach(function (el) { el.classList.remove('hidden'); });
        }
    }

    if (toggle && sidebar && main) {
        applyState(isCollapsed());
        toggle.addEventListener('click', function () {
            var collapsed = !isCollapsed();
            localStorage.setItem(STORAGE_KEY, collapsed ? '1' : '0');
            applyState(collapsed);
        });
    }
})();
</script>
